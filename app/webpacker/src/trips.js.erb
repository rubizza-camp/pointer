import axios from 'axios'
import Pusher from 'pusher-js'
$(document).ready((function (_this) {
    return function () {
        var channel, data, getCurrentLocation, getLocation, initMap, isOwner, makeNum, map, pusher, saveTrip, showLat,
            showLng, startingPoint, tripId, updateCurrentLocation, updateMap;
        tripId = '';
        startingPoint = {};
        isOwner = false;
        map = null;
        makeNum = function (arr) {
            arr.forEach(function (arr) {
                arr.lat = Number(arr.lat);
                arr.lng = Number(arr.lng);
            });
            return arr;
        };
        saveTrip = function (positionData) {
            var token;
            isOwner = true;
            token = $('meta[name="csrf-token"]').attr('content');
            $.ajax({
                url: '/trips',
                type: 'post',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-CSRF-Token', token);
                },
                dataType: "json",
                data: positionData,
                success: function (response) {
                    var url;
                    console.log(response);
                    tripId = response.id;
                    url = window.location.protocol + "//" + window.location.host + "/tripwatcher/" + response.uuid;
                    initMap();
                    $('.name-form').addClass('collapse');
                    $('.share-url').append("<h6 class=\"m-0 text-center\">Hello <strong>" + (unescape(response.name)) + "</strong>, here's your location sharing link: <a href=\"" + url + "\">" + url + "</a></h6>");
                    getCurrentLocation();
                }
            });
        };
        getLocation = function (name) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var coord, data, timestamp;
                    coord = position.coords;
                    timestamp = position.timestamp;
                    data = {
                        lat: coord.latitude,
                        lng: coord.longitude,
                        name: name
                    };
                    startingPoint = data;
                    return saveTrip(data);
                });
            }
        };
        initMap = function () {
            var center, marker;
            center = {
                lat: startingPoint.lat,
                lng: startingPoint.lng
            };
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 18,
                center: center
            });
            marker = new google.maps.Marker({
                position: center,
                map: map
            });
        };
        updateMap = function (checkin) {
            var center, flightPath, lastCheckin, marker;
            console.log(checkin);
            lastCheckin = checkin[checkin.length - 1];
            center = {
                lat: startingPoint.lat,
                lng: startingPoint.lng
            };
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 18,
                center: center
            });
            marker = new google.maps.Marker({
                position: lastCheckin,
                map: map
            });
            flightPath = new google.maps.Polyline({
                path: checkin,
                strokeColor: '#FF0000',
                strokeOpacity: 1.0,
                strokeWeight: 2
            });
            flightPath.setMap(map);
            if (isOwner) {
                setTimeout(getCurrentLocation, 5000);
            }
        };
        updateCurrentLocation = function (tripData, id) {
            var token;
            token = $('meta[name="csrf-token"]').attr('content');
            axios({
                url: "/trips/" + id + "/checkins",
                method: 'POST',
                headers: {
                    'X-CSRF-Token': token
                },
                data: tripData,
                success: function (response) {
                }
            }).then(function(response) {console.log(response)})
        };
        getCurrentLocation = function () {
            navigator.geolocation.getCurrentPosition(function (position) {
                var data;
                data = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                return updateCurrentLocation(data, tripId);
            });
        };
        if (location.pathname.startsWith('/trips')) {
            $('.name-form').on('submit', function (event) {
                var data, formData, name;
                event.preventDefault();
                formData = $(this).serialize();
                name = formData.split('=')[1];
                data = getLocation(name);
            });
        }
        if (location.pathname.startsWith('/tripwatcher')) {
            showLat = $('#lat').val();
            showLng = $('#lng').val();
            data = {
                lat: Number(showLat),
                lng: Number(showLng)
            };
            startingPoint = data;
            initMap();
        }
        pusher = new Pusher('<%= ENV["PUSHER_KEY"] %>', {
            cluster: '<%= ENV["PUSHER_CLUSTER"] %>',
            encrypted: true
        });
        channel = pusher.subscribe('location');
        channel.bind('new', function (data) {
            updateMap(makeNum(data.checkins));
        });
    };
})(this));
